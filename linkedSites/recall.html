<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>re:call</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --border: #333;
            --accent: #888;
            --gradient-start: #2a2a2a;
            --gradient-end: #1f1f1f;
            --success: #4a7;
            --danger: #a44;
            --warning: #d94;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            padding: 3rem 0 2rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.24s ease;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--accent), #666);
            border-color: var(--accent);
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.28s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.24s ease;
        }

        .card:hover {
            border-color: var(--accent);
        }

        /* Buttons */
        .btn {
            padding: 0.7rem 1.5rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.24s ease;
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #666);
            border-color: var(--accent);
        }

        .btn-danger {
            background: linear-gradient(135deg, #a44, #822);
            border-color: #a44;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4a7, #396);
            border-color: #4a7;
        }

        /* Inputs */
        input, textarea, select {
            width: 100%;
            padding: 0.7rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.24s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .row {
            display: flex;
            gap: 1rem;
        }
        
        .col {
            flex: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: modalFadeIn 0.26s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            animation: modalScaleIn 0.26s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalScaleIn {
            from { transform: scale(0.98); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Stats & Tags */
        .tag {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .tag.difficulty-Easy { background: rgba(74, 170, 119, 0.2); border-color: var(--success); color: var(--success); }
        .tag.difficulty-Medium { background: rgba(221, 153, 68, 0.2); border-color: var(--warning); color: var(--warning); }
        .tag.difficulty-Hard { background: rgba(170, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); }

        .chart-container {
            width: 100%;
            height: 250px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            position: relative;
        }

        /* Study Area Specifics */
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 1rem;
        }

        .timer-badge {
            font-family: monospace;
            font-size: 1.1rem;
            background: var(--bg-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        /* Flashcard Flip */
        .flashcard-container {
            perspective: 1500px;
            margin: 2rem auto;
            max-width: 600px;
        }

        .flashcard {
            position: relative;
            width: 100%;
            min-height: 300px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.42s ease-in-out;
        }

        .flashcard.flipped {
            transform: rotateX(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            min-height: 300px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.3rem;
            backface-visibility: hidden;
            flex-direction: column;
        }

        .flashcard-back {
            transform: rotateX(180deg);
        }

        .flashcard-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Quiz */
        .quiz-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #999);
            transition: width 0.28s ease;
        }

        .quiz-question {
            animation: slideIn 0.28s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .quiz-option {
            padding: 1rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.24s ease;
        }

        .quiz-option:hover {
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .quiz-option.selected {
            background: linear-gradient(135deg, var(--accent), #666);
            border-color: var(--accent);
        }

        .quiz-option.correct {
            background: linear-gradient(135deg, #4a7, #396);
            border-color: #4a7;
        }

        .quiz-option.incorrect {
            background: linear-gradient(135deg, #a44, #822);
            border-color: #a44;
        }

        /* Deck List */
        .deck-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .deck-item {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.24s ease;
        }

        .deck-item:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
        }

        .deck-item.selected {
            background: linear-gradient(135deg, var(--accent), #666);
            border-color: var(--accent);
        }

        .deck-name {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .deck-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .deck-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .deck-actions button {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Theme Editor */
        .theme-editor {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            cursor: pointer;
        }

        /* Custom Checkbox */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.24s ease;
            flex-shrink: 0;
        }

        input[type="checkbox"]:hover {
            border-color: var(--accent);
        }

        input[type="checkbox"]:checked {
            background: linear-gradient(135deg, var(--accent), #666);
            border-color: var(--accent);
        }

        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: bold;
        }

        /* Custom Radio Buttons */
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all 0.24s ease;
            flex-shrink: 0;
        }

        input[type="radio"]:hover {
            border-color: var(--accent);
        }

        input[type="radio"]:checked {
            border-color: var(--accent);
        }

        input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #666);
        }

        .gradient-preview {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }

        /* Interactive Labels (Hover effects for lists) */
        .interactive-label {
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            margin-bottom: 0.5rem; 
            cursor: pointer; 
            padding: 0.5rem; 
            border-radius: 6px; 
            transition: background 0.24s ease;
        }

        .interactive-label:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Print Specific Styles */
        .print-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            background: var(--bg-secondary);
        }

        .print-card-item {
            display: flex;
            gap: 1rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            align-items: flex-start;
        }

        .print-card-item:last-child {
            border-bottom: none;
        }

        .print-card-content {
            flex: 1;
        }

        /* Success/Error Messages */
        .message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }

        .message.success {
            background: rgba(68, 170, 119, 0.1);
            border: 1px solid #4a7;
            color: #4a7;
        }

        .message.error {
            background: rgba(170, 68, 68, 0.1);
            border: 1px solid #a44;
            color: #a44;
        }

        /* Results */
        .results-container {
            text-align: center;
            max-width: 500px;
            margin: 2rem auto;
        }

        .results-score {
            font-size: 4rem;
            font-weight: 600;
            margin: 2rem 0;
            background: linear-gradient(135deg, var(--accent), #999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Utility */
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 2rem; }
        .flex { display: flex; }
        .gap-1 { gap: 1rem; }
        .justify-between { justify-content: space-between; }

        /* Subtle Footer */
        .subtle-footer {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            color: var(--text-secondary);
            font-size: 0.75rem;
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>re:call</h1>
            <p>modern flashcards for free by Jonah Feinberg</p>
        </div>

        <nav class="nav">
            <button class="nav-btn active" data-section="decks">Manage Decks</button>
            <button class="nav-btn" data-section="cards">Create Cards</button>
            <button class="nav-btn" data-section="study">Study</button>
            <button class="nav-btn" data-section="quiz">Quiz</button>
            <button class="nav-btn" data-section="stats">Stats</button>
            <button class="nav-btn" data-section="settings">Settings</button>
        </nav>

        <!-- Manage Decks -->
        <section class="section active" id="decks">
            <div id="deckListView">
                <div class="flex justify-between mb-2">
                    <h2>Your Decks</h2>
                    <button class="btn btn-primary" onclick="app.showCreateDeckModal()">New Deck</button>
                </div>
                <div class="deck-list" id="deckList"></div>
            </div>
            
            <div id="deckCardsView" style="display: none;">
                <div class="flex justify-between mb-2">
                    <h2 id="currentDeckTitle"></h2>
                    <button class="btn" onclick="app.closeDeckCards()">← Back to Decks</button>
                </div>
                <div id="deckCardsList"></div>
            </div>
        </section>

        <!-- Create Cards -->
        <section class="section" id="cards">
            <h2 class="mb-2">Create Flashcard</h2>
            <div class="card">
                <div class="form-group">
                    <label>Deck</label>
                    <select id="cardDeck">
                        <option value="">Select a deck</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col form-group">
                        <label>Difficulty</label>
                        <select id="cardDifficulty">
                            <option value="Medium">Medium</option>
                            <option value="Easy">Easy</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="cardTags" placeholder="e.g. vocab, chapter 1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Front (Question)</label>
                    <textarea id="cardFront" placeholder="Enter question..."></textarea>
                </div>
                <div class="form-group">
                    <label>Back (Answer)</label>
                    <textarea id="cardBack" placeholder="Enter answer..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="app.saveCard()">Save Card</button>
            </div>
        </section>

        <!-- Study Mode -->
        <section class="section" id="study">
            <h2 class="mb-2 text-center">Study Mode</h2>
            <div id="studySetup">
                <div class="card">
                    <h3 class="mb-1">Options</h3>
                    <div class="row">
                        <div class="col">
                            <label style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; cursor: pointer;">
                                <input type="checkbox" id="studyRandomize">
                                <span>Randomize Order</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                <input type="checkbox" id="studyReverse">
                                <span>Reverse Mode</span>
                            </label>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Filter by Difficulty</label>
                                <select id="studyDifficultyFilter">
                                    <option value="all">All Difficulties</option>
                                    <option value="Hard">Hard Only</option>
                                    <option value="Medium">Medium Only</option>
                                    <option value="Easy">Easy Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mt-2">
                        <label>Filter by Tag (Optional)</label>
                        <input type="text" id="studyTagFilter" placeholder="Type a tag to filter (e.g. vocab)">
                    </div>
                </div>
                
                <div class="card" style="margin-top: 1rem;">
                    <h3 class="mb-1">Select Decks to Study</h3>
                    <div id="studyDeckSelection"></div>
                    <div class="mt-2">
                        <button class="btn btn-primary" onclick="app.startStudy()">Start Studying</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3 class="mb-1">Print Tools</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Generate PDF study sheets or paper quizzes from your decks.</p>
                    <button class="btn" onclick="app.showPrintInterface()">Open Print Tools</button>
                </div>
            </div>

            <!-- Print Interface -->
            <div id="printSetup" style="display: none;">
                <div class="card">
                    <div class="flex justify-between mb-2">
                        <h3 class="mb-1">Configure Printout</h3>
                        <button class="btn" onclick="app.hidePrintInterface()">Cancel</button>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <h4 class="mb-1">1. Select Decks</h4>
                            <div id="printDeckSelection" class="mb-2"></div>
                        </div>
                        <div class="col">
                            <h4 class="mb-1">2. Print Mode</h4>
                            <div class="form-group">
                                <label class="interactive-label">
                                    <input type="radio" name="printMode" value="sheet" checked onchange="app.updatePrintMode(this.value)">
                                    <span>Study Sheet (Q & A)</span>
                                </label>
                                <label class="interactive-label">
                                    <input type="radio" name="printMode" value="quiz" onchange="app.updatePrintMode(this.value)">
                                    <span>Quiz (Q Only)</span>
                                </label>
                                <label class="interactive-label">
                                    <input type="radio" name="printMode" value="quiz_key" onchange="app.updatePrintMode(this.value)">
                                    <span>Quiz + Answer Key</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <h4 class="mb-1">3. Select Cards</h4>
                    <div class="flex gap-1 mb-1">
                        <button class="btn" style="font-size:0.8rem; padding: 0.4rem 0.8rem;" onclick="app.toggleAllPrintCards(true)">Select All</button>
                        <button class="btn" style="font-size:0.8rem; padding: 0.4rem 0.8rem;" onclick="app.toggleAllPrintCards(false)">Deselect All</button>
                    </div>
                    <div id="printCardList" class="print-list mb-2">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Select decks to view cards</p>
                    </div>

                    <button class="btn btn-primary" onclick="app.generatePrint()">Generate Printout</button>
                </div>
            </div>

            <div id="studyArea" style="display: none;">
                <div class="study-header">
                    <div class="timer-badge" id="studyTimerDisplay">00:00</div>
                    <button class="btn btn-success" onclick="app.markAsKnown()">Mark as Known (Session)</button>
                </div>
                <div class="flashcard-container">
                    <div class="flashcard" id="flashcard" onclick="app.flipCard()">
                        <div class="flashcard-face flashcard-front" id="studyCardFront">
                            Click or press Space to flip
                        </div>
                        <div class="flashcard-face flashcard-back" id="studyCardBack">
                            Answer appears here
                        </div>
                    </div>
                </div>
                <div class="flashcard-controls">
                    <button class="btn" onclick="app.prevCard()">← Previous</button>
                    <span id="cardCounter">0 / 0</span>
                    <button class="btn" onclick="app.nextCard()">Next →</button>
                </div>
                <div class="text-center mt-2">
                    <button class="btn" onclick="app.exitStudy()">Exit Study Mode</button>
                </div>
            </div>
        </section>

        <!-- Quiz Mode -->
        <section class="section" id="quiz">
            <h2 class="mb-2 text-center">Quiz Mode</h2>
            <div id="quizSetup">
                <div class="card">
                    <h3 class="mb-1">Quiz Setup</h3>
                    <div class="form-group">
                        <label>Select Decks</label>
                        <div id="quizDeckSelection"></div>
                    </div>
                    <div class="form-group">
                        <label>Number of Questions</label>
                        <input type="number" id="quizQuestionCount" min="1" value="10">
                    </div>
                    <div class="form-group">
                        <label>Question Order</label>
                        <select id="quizOrder">
                            <option value="random">Random</option>
                            <option value="deck">Deck Order</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Question Types</label>
                        <select id="quizType">
                            <option value="mixed">Mixed</option>
                            <option value="typed">Typed Answer</option>
                            <option value="multiple">Multiple Choice</option>
                            <option value="truefalse">True / False</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="app.startQuiz()">Start Quiz</button>
                </div>
            </div>
            <div id="quizArea" style="display: none;">
                <div class="quiz-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="quizProgress"></div>
                    </div>
                    <div class="quiz-question" id="quizQuestion"></div>
                </div>
            </div>
            <div id="quizResults" style="display: none;">
                <div class="results-container">
                    <h2>Quiz Complete!</h2>
                    <p style="margin-bottom: 2rem; color: var(--text-secondary);">Your results have been saved to stats.</p>
                    <div class="results-score" id="quizScore">0%</div>
                    <div class="results-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="correctCount">0</div>
                            <div class="stat-label">Correct</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="incorrectCount">0</div>
                            <div class="stat-label">Incorrect</div>
                        </div>
                    </div>
                    <div class="flex gap-1 mt-2">
                        <button class="btn" onclick="app.retryMissed()">Retry Missed</button>
                        <button class="btn" onclick="app.studyMissed()">Study Missed</button>
                        <button class="btn btn-primary" onclick="app.restartQuiz()">New Quiz</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Mode -->
        <section class="section" id="stats">
            <h2 class="mb-2">Statistics & Trends</h2>
            
            <div class="results-stats" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-value" id="statsTotalReviews">0</div>
                    <div class="stat-label">Total Reviews (All Time)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsGlobalAccuracy">0%</div>
                    <div class="stat-label">Overall Accuracy</div>
                </div>
            </div>

            <div class="card">
                <h3 class="mb-1">Last 7 Days Activity</h3>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <h3 class="mb-1" style="margin-top: 2rem;">Problem Cards (Lowest Accuracy)</h3>
            <div id="difficultCardsList"></div>
        </section>

        <!-- Settings -->
        <section class="section" id="settings">
            <h2 class="mb-2">Settings</h2>
            
            <div class="theme-editor">
                <h3 class="mb-1">Save & Load Data</h3>
                <div class="form-group">
                    <label>Export Your Data</label>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
                        Copy this text to back up all your decks and cards
                    </p>
                    <textarea id="exportData" readonly style="min-height: 120px; font-family: monospace; font-size: 0.85rem;"></textarea>
                    <div class="flex gap-1 mt-2">
                        <button class="btn btn-primary" onclick="app.exportData()">Generate Export</button>
                        <button class="btn" onclick="app.copyExport()">Copy to Clipboard</button>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 2rem;">
                    <label>Import Data</label>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
                        Paste your exported data here to restore your decks and cards
                    </p>
                    <textarea id="importData" placeholder="Paste your exported data here..." style="min-height: 120px; font-family: monospace; font-size: 0.85rem;"></textarea>
                    <button class="btn btn-primary" onclick="app.importData()" style="margin-top: 0.75rem;">Load Data</button>
                    <p style="color: #a44; font-size: 0.85rem; margin-top: 0.5rem;">
                        ⚠️ Warning: This will replace all your current data
                    </p>
                </div>
            </div>
            
            <div class="theme-editor">
                <h3 class="mb-1">Theme Customization</h3>
                <div class="form-group">
                    <label>Accent Color</label>
                    <div class="color-picker-group">
                        <input type="color" id="accentColor" value="#888888">
                    </div>
                </div>
                <div class="form-group">
                    <label>Background Gradient</label>
                    <div class="color-picker-group">
                        <div>
                            <label style="font-size: 0.85rem;">Start</label>
                            <input type="color" id="bgGradientStart" value="#1a1a1a">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem;">End</label>
                            <input type="color" id="bgGradientEnd" value="#0f0f0f">
                        </div>
                    </div>
                    <div class="gradient-preview" id="gradientPreview"></div>
                </div>
                <div class="form-group">
                    <label>Card Gradient</label>
                    <div class="color-picker-group">
                        <div>
                            <label style="font-size: 0.85rem;">Start</label>
                            <input type="color" id="cardGradientStart" value="#2a2a2a">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem;">End</label>
                            <input type="color" id="cardGradientEnd" value="#1f1f1f">
                        </div>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button class="btn btn-primary" onclick="app.applyTheme()">Apply Theme</button>
                    <button class="btn" onclick="app.resetTheme()">Reset to Default</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Modals -->
    <div class="modal" id="deckModal">
        <div class="modal-content">
            <h3 class="modal-header" id="deckModalTitle">Create Deck</h3>
            <div class="form-group">
                <label>Deck Name</label>
                <input type="text" id="deckName" placeholder="e.g., Biology Chapter 3">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="app.closeDeckModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveDeck()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deckThemeModal">
        <div class="modal-content">
            <h3 class="modal-header">Customize Deck Theme</h3>
            <div class="form-group">
                <label>Deck Color</label>
                <input type="color" id="deckColor" value="#888888">
            </div>
            <div class="form-group">
                <label>Card Background</label>
                <div class="color-picker-group">
                    <div>
                        <label style="font-size: 0.85rem;">Start</label>
                        <input type="color" id="deckCardStart" value="#2a2a2a">
                    </div>
                    <div>
                        <label style="font-size: 0.85rem;">End</label>
                        <input type="color" id="deckCardEnd" value="#1f1f1f">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="app.closeDeckThemeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveDeckTheme()">Save Theme</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content">
            <h3 class="modal-header">Delete Deck?</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Are you sure you want to delete "<span id="deleteDeckName"></span>"? 
                This will permanently delete the deck and all <span id="deleteDeckCount"></span> cards inside it.
                This action cannot be undone.
            </p>
            <div class="modal-actions">
                <button class="btn" onclick="app.closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="app.confirmDelete()">Delete Forever</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importConfirmModal">
        <div class="modal-content">
            <h3 class="modal-header">Import Data?</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                This will replace all your current data with the imported data:
            </p>
            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <p><strong>Importing:</strong></p>
                <p><span id="importDeckCount">0</span> decks</p>
                <p><span id="importCardCount">0</span> cards</p>
            </div>
            <p style="color: #a44; font-size: 0.9rem; margin-bottom: 1.5rem;">
                ⚠️ Your current data will be permanently replaced. This cannot be undone.
            </p>
            <div class="modal-actions">
                <button class="btn" onclick="app.closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.confirmImport()">Import Data</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editCardModal">
        <div class="modal-content">
            <h3 class="modal-header">Edit Card</h3>
            <div class="row">
                <div class="col form-group">
                    <label>Difficulty</label>
                    <select id="editCardDifficulty">
                        <option value="Medium">Medium</option>
                        <option value="Easy">Easy</option>
                        <option value="Hard">Hard</option>
                    </select>
                </div>
                <div class="col form-group">
                    <label>Tags</label>
                    <input type="text" id="editCardTags" placeholder="Comma separated">
                </div>
            </div>
            <div class="form-group">
                <label>Front (Question)</label>
                <textarea id="editCardFront" placeholder="Enter question..."></textarea>
            </div>
            <div class="form-group">
                <label>Back (Answer)</label>
                <textarea id="editCardBack" placeholder="Enter answer..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="app.closeEditCardModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveEditedCard()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteCardModal">
        <div class="modal-content">
            <h3 class="modal-header">Delete Card?</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Are you sure you want to delete this card? This action cannot be undone.
            </p>
            <div class="modal-actions">
                <button class="btn" onclick="app.closeDeleteCardModal()">Cancel</button>
                <button class="btn btn-danger" onclick="app.confirmDeleteCard()">Delete Card</button>
            </div>
        </div>
    </div>

    <div class="subtle-footer">Jonah Feinberg</div>

    <script>
        // App State
        const app = {
            decks: [],
            cards: [],
            currentDeck: null,
            editingDeck: null,
            themingDeck: null,
            deletingDeckId: null,
            pendingImportData: null,
            editingCard: null,
            deletingCardId: null,
            viewingDeckId: null,
            
            // Study State
            studyCards: [],
            studyIndex: 0,
            studyTimer: null,
            studySeconds: 0,
            isReverse: false,
            
            // Print State
            printState: {
                selectedDecks: [],
                selectedCards: [],
                mode: 'sheet' // sheet, quiz, quiz_key
            },

            // Quiz State
            quizState: {
                questions: [],
                currentIndex: 0,
                answers: [],
                missedCards: []
            },

            // Initialize
            init() {
                this.loadData();
                this.renderDecks();
                this.setupNavigation();
                this.setupKeyboardShortcuts();
                this.populateDeckSelects();
                this.loadTheme();
                this.setupThemeListeners();
            },

            setupThemeListeners() {
                const bgStart = document.getElementById('bgGradientStart');
                const bgEnd = document.getElementById('bgGradientEnd');
                
                if (bgStart && bgEnd) {
                    bgStart.addEventListener('input', () => this.updateGradientPreview());
                    bgEnd.addEventListener('input', () => this.updateGradientPreview());
                }
            },

            // Data Management
            loadData() {
                this.decks = JSON.parse(localStorage.getItem('recall_decks') || '[]');
                this.cards = JSON.parse(localStorage.getItem('recall_cards') || '[]');
                
                // Migrate Data: Ensure all cards have new fields
                this.cards = this.cards.map(card => ({
                    ...card,
                    difficulty: card.difficulty || 'Medium',
                    tags: card.tags || [],
                    stats: card.stats || { correct: 0, attempts: 0, history: [] }
                }));

                // Create default deck if none exist
                if (this.decks.length === 0) {
                    this.decks.push({
                        id: Date.now(),
                        name: 'General',
                        created: Date.now(),
                        color: '#888888',
                        cardGradientStart: '#2a2a2a',
                        cardGradientEnd: '#1f1f1f'
                    });
                    this.saveData();
                }
            },

            saveData() {
                localStorage.setItem('recall_decks', JSON.stringify(this.decks));
                localStorage.setItem('recall_cards', JSON.stringify(this.cards));
            },

            // Navigation
            setupNavigation() {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const section = btn.dataset.section;
                        this.navigateTo(section);
                    });
                });
            },

            navigateTo(section) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                
                document.getElementById(section).classList.add('active');
                document.querySelector(`[data-section="${section}"]`).classList.add('active');

                // Refresh views
                if (section === 'decks') {
                    this.closeDeckCards();
                    this.renderDecks();
                }
                if (section === 'cards') this.populateDeckSelects();
                if (section === 'study') {
                    this.renderStudySetup();
                    this.hidePrintInterface();
                }
                if (section === 'quiz') this.renderQuizSetup();
                if (section === 'stats') this.renderStats();
                if (section === 'settings') {
                    document.getElementById('exportData').value = '';
                    document.getElementById('importData').value = '';
                    const messages = document.querySelectorAll('.message');
                    messages.forEach(msg => msg.remove());
                }
            },

            // Deck Management
            renderDecks() {
                const container = document.getElementById('deckList');
                container.innerHTML = this.decks.map(deck => {
                    const cardCount = this.cards.filter(c => c.deckId === deck.id).length;
                    const deckColor = deck.color || '#888888';
                    const gradientStart = deck.cardGradientStart || '#2a2a2a';
                    const gradientEnd = deck.cardGradientEnd || '#1f1f1f';
                    
                    return `
                        <div class="deck-item ${this.currentDeck === deck.id ? 'selected' : ''}" 
                             style="background: linear-gradient(135deg, ${gradientStart}, ${gradientEnd}); border-color: ${deckColor};"
                             onclick="app.viewDeckCards(${deck.id})">
                            <div class="deck-name">${deck.name}</div>
                            <div class="deck-count">${cardCount} cards</div>
                            <div class="deck-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-primary" onclick="app.addCardToDeck(${deck.id})">Add Card</button>
                                <button class="btn" onclick="app.duplicateDeck(${deck.id})">Duplicate</button>
                                <button class="btn" onclick="app.editDeck(${deck.id})">Edit</button>
                                <button class="btn" onclick="app.customizeDeckTheme(${deck.id})">Theme</button>
                                <button class="btn btn-danger" onclick="app.deleteDeck(${deck.id})">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            showCreateDeckModal() {
                this.editingDeck = null;
                document.getElementById('deckModalTitle').textContent = 'Create Deck';
                document.getElementById('deckName').value = '';
                document.getElementById('deckModal').classList.add('active');
            },

            editDeck(id) {
                const deck = this.decks.find(d => d.id === id);
                if (!deck) return;

                this.editingDeck = deck;
                document.getElementById('deckModalTitle').textContent = 'Edit Deck';
                document.getElementById('deckName').value = deck.name;
                document.getElementById('deckModal').classList.add('active');
            },

            closeDeckModal() {
                document.getElementById('deckModal').classList.remove('active');
            },

            saveDeck() {
                const name = document.getElementById('deckName').value.trim();
                if (!name) return;

                if (this.editingDeck) {
                    this.editingDeck.name = name;
                } else {
                    this.decks.push({
                        id: Date.now(),
                        name: name,
                        created: Date.now(),
                        color: '#888888',
                        cardGradientStart: '#2a2a2a',
                        cardGradientEnd: '#1f1f1f'
                    });
                }

                this.saveData();
                this.renderDecks();
                this.populateDeckSelects();
                this.closeDeckModal();
            },

            duplicateDeck(id) {
                const deck = this.decks.find(d => d.id === id);
                if (!deck) return;

                const newDeckId = Date.now();
                const newDeck = {
                    ...deck,
                    id: newDeckId,
                    name: deck.name + ' (Copy)',
                    created: Date.now()
                };

                this.decks.push(newDeck);

                // Duplicate all cards
                const deckCards = this.cards.filter(c => c.deckId === id);
                deckCards.forEach(card => {
                    this.cards.push({
                        ...card,
                        id: Date.now() + Math.random(),
                        deckId: newDeckId,
                        stats: { correct: 0, attempts: 0, history: [] } // Reset stats for copies
                    });
                });

                this.saveData();
                this.renderDecks();
            },

            customizeDeckTheme(id) {
                const deck = this.decks.find(d => d.id === id);
                if (!deck) return;

                this.themingDeck = deck;
                document.getElementById('deckColor').value = deck.color || '#888888';
                document.getElementById('deckCardStart').value = deck.cardGradientStart || '#2a2a2a';
                document.getElementById('deckCardEnd').value = deck.cardGradientEnd || '#1f1f1f';
                document.getElementById('deckThemeModal').classList.add('active');
            },

            closeDeckThemeModal() {
                document.getElementById('deckThemeModal').classList.remove('active');
                this.themingDeck = null;
            },

            saveDeckTheme() {
                if (!this.themingDeck) return;

                this.themingDeck.color = document.getElementById('deckColor').value;
                this.themingDeck.cardGradientStart = document.getElementById('deckCardStart').value;
                this.themingDeck.cardGradientEnd = document.getElementById('deckCardEnd').value;

                this.saveData();
                this.renderDecks();
                this.closeDeckThemeModal();
            },

            deleteDeck(id) {
                const deck = this.decks.find(d => d.id === id);
                if (!deck) return;
                
                const cardCount = this.cards.filter(c => c.deckId === id).length;
                
                this.deletingDeckId = id;
                document.getElementById('deleteDeckName').textContent = deck.name;
                document.getElementById('deleteDeckCount').textContent = cardCount;
                document.getElementById('deleteConfirmModal').classList.add('active');
            },

            closeDeleteModal() {
                document.getElementById('deleteConfirmModal').classList.remove('active');
                this.deletingDeckId = null;
            },

            confirmDelete() {
                if (!this.deletingDeckId) return;
                
                this.decks = this.decks.filter(d => d.id !== this.deletingDeckId);
                this.cards = this.cards.filter(c => c.deckId !== this.deletingDeckId);
                this.saveData();
                this.renderDecks();
                this.populateDeckSelects();
                this.closeDeleteModal();
            },

            addCardToDeck(deckId) {
                this.navigateTo('cards');
                setTimeout(() => {
                    document.getElementById('cardDeck').value = deckId;
                }, 100);
            },

            viewDeckCards(deckId) {
                this.viewingDeckId = deckId;
                const deck = this.decks.find(d => d.id === deckId);
                if (!deck) return;

                document.getElementById('currentDeckTitle').textContent = deck.name;
                document.getElementById('deckListView').style.display = 'none';
                document.getElementById('deckCardsView').style.display = 'block';
                
                this.renderDeckCards();
            },

            renderDeckCards() {
                const container = document.getElementById('deckCardsList');
                const deckCards = this.cards.filter(c => c.deckId === this.viewingDeckId);
                
                if (deckCards.length === 0) {
                    container.innerHTML = `
                        <div class="card text-center">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">No cards in this deck yet.</p>
                            <button class="btn btn-primary" onclick="app.addCardToDeck(${this.viewingDeckId})">Add Your First Card</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = deckCards.map(card => {
                    const tagHtml = card.tags.map(t => `<span class="tag">${t}</span>`).join('');
                    return `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <span class="tag difficulty-${card.difficulty}">${card.difficulty}</span>
                                ${tagHtml}
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-secondary); font-size: 0.85rem;">QUESTION:</strong>
                            <p style="margin-top: 0.5rem;">${card.front}</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-secondary); font-size: 0.85rem;">ANSWER:</strong>
                            <p style="margin-top: 0.5rem;">${card.back}</p>
                        </div>
                        <div class="flex gap-1">
                            <button class="btn" onclick="app.editCard(${card.id})">Edit</button>
                            <button class="btn btn-danger" onclick="app.deleteCard(${card.id})">Delete</button>
                        </div>
                    </div>
                `}).join('');
            },

            closeDeckCards() {
                if (document.getElementById('deckCardsView').style.display !== 'none') {
                    document.getElementById('deckCardsView').style.display = 'none';
                    document.getElementById('deckListView').style.display = 'block';
                    this.viewingDeckId = null;
                }
            },

            editCard(cardId) {
                const card = this.cards.find(c => c.id === cardId);
                if (!card) return;

                this.editingCard = card;
                document.getElementById('editCardFront').value = card.front;
                document.getElementById('editCardBack').value = card.back;
                document.getElementById('editCardDifficulty').value = card.difficulty;
                document.getElementById('editCardTags').value = card.tags.join(', ');
                document.getElementById('editCardModal').classList.add('active');
            },

            closeEditCardModal() {
                document.getElementById('editCardModal').classList.remove('active');
                this.editingCard = null;
            },

            saveEditedCard() {
                if (!this.editingCard) return;

                const front = document.getElementById('editCardFront').value.trim();
                const back = document.getElementById('editCardBack').value.trim();
                const difficulty = document.getElementById('editCardDifficulty').value;
                const tagStr = document.getElementById('editCardTags').value.trim();
                const tags = tagStr ? tagStr.split(',').map(t => t.trim()).filter(t => t) : [];

                if (!front || !back) {
                    alert('Please fill both fields');
                    return;
                }

                this.editingCard.front = front;
                this.editingCard.back = back;
                this.editingCard.difficulty = difficulty;
                this.editingCard.tags = tags;

                this.saveData();
                this.renderDeckCards();
                this.closeEditCardModal();
            },

            deleteCard(cardId) {
                this.deletingCardId = cardId;
                document.getElementById('deleteCardModal').classList.add('active');
            },

            closeDeleteCardModal() {
                document.getElementById('deleteCardModal').classList.remove('active');
                this.deletingCardId = null;
            },

            confirmDeleteCard() {
                if (!this.deletingCardId) return;

                this.cards = this.cards.filter(c => c.id !== this.deletingCardId);
                this.saveData();
                this.renderDeckCards();
                this.closeDeleteCardModal();
            },

            // Card Management
            populateDeckSelects() {
                const selects = ['cardDeck'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    
                    select.innerHTML = '<option value="">Select a deck</option>' +
                        this.decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                });
            },

            saveCard() {
                const deckId = parseInt(document.getElementById('cardDeck').value);
                const front = document.getElementById('cardFront').value.trim();
                const back = document.getElementById('cardBack').value.trim();
                const difficulty = document.getElementById('cardDifficulty').value;
                const tagStr = document.getElementById('cardTags').value.trim();
                const tags = tagStr ? tagStr.split(',').map(t => t.trim()).filter(t => t) : [];

                if (!deckId || !front || !back) {
                    alert('Please fill all fields');
                    return;
                }

                this.cards.push({
                    id: Date.now(),
                    deckId: deckId,
                    front: front,
                    back: back,
                    difficulty: difficulty,
                    tags: tags,
                    created: Date.now(),
                    stats: { correct: 0, attempts: 0, history: [] }
                });

                this.saveData();
                document.getElementById('cardFront').value = '';
                document.getElementById('cardBack').value = '';
                document.getElementById('cardTags').value = '';
            },

            // Study Mode
            renderStudySetup() {
                const container = document.getElementById('studyDeckSelection');
                container.innerHTML = this.decks.map(deck => {
                    const cardCount = this.cards.filter(c => c.deckId === deck.id).length;
                    return `
                        <label class="interactive-label">
                            <input type="checkbox" data-deck-id="${deck.id}">
                            <span>${deck.name} (${cardCount} cards)</span>
                        </label>
                    `;
                }).join('');
            },

            startStudy() {
                const selected = Array.from(document.querySelectorAll('#studyDeckSelection input:checked'))
                    .map(cb => parseInt(cb.dataset.deckId));

                if (selected.length === 0) {
                    alert('Select at least one deck');
                    return;
                }

                const randomize = document.getElementById('studyRandomize').checked;
                const diffFilter = document.getElementById('studyDifficultyFilter').value;
                const tagFilter = document.getElementById('studyTagFilter').value.trim().toLowerCase();
                this.isReverse = document.getElementById('studyReverse').checked;

                // Base filter by deck
                let filtered = this.cards.filter(c => selected.includes(c.deckId));
                
                // Filter by difficulty
                if (diffFilter !== 'all') {
                    filtered = filtered.filter(c => c.difficulty === diffFilter);
                }

                // Filter by tag
                if (tagFilter) {
                    filtered = filtered.filter(c => 
                        c.tags.some(t => t.toLowerCase().includes(tagFilter))
                    );
                }
                
                if (filtered.length === 0) {
                    alert('No cards match your criteria');
                    return;
                }

                this.studyCards = filtered;
                
                if (randomize) {
                    this.studyCards = this.shuffle(this.studyCards);
                }

                this.studyIndex = 0;
                document.getElementById('studySetup').style.display = 'none';
                document.getElementById('studyArea').style.display = 'block';
                
                this.startTimer();
                this.showStudyCard();
            },

            startTimer() {
                this.studySeconds = 0;
                clearInterval(this.studyTimer);
                document.getElementById('studyTimerDisplay').textContent = "00:00";
                
                this.studyTimer = setInterval(() => {
                    this.studySeconds++;
                    const mins = Math.floor(this.studySeconds / 60).toString().padStart(2, '0');
                    const secs = (this.studySeconds % 60).toString().padStart(2, '0');
                    document.getElementById('studyTimerDisplay').textContent = `${mins}:${secs}`;
                }, 1000);
            },

            markAsKnown() {
                if (this.studyCards.length === 0) return;
                
                this.studyCards.splice(this.studyIndex, 1);
                
                if (this.studyCards.length === 0) {
                    this.exitStudy();
                    return;
                }
                
                if (this.studyIndex >= this.studyCards.length) {
                    this.studyIndex = 0;
                }
                
                this.showStudyCard();
            },

            showStudyCard() {
                if (this.studyCards.length === 0) return;
                
                const card = this.studyCards[this.studyIndex];
                const deck = this.decks.find(d => d.id === card.deckId);
                
                const frontContent = this.isReverse ? card.back : card.front;
                const backContent = this.isReverse ? card.front : card.back;
                
                // Add tag badges to card
                const tagHtml = `<div style="margin-bottom: 1rem;">
                    <span class="tag difficulty-${card.difficulty}">${card.difficulty}</span>
                    ${card.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                </div>`;

                document.getElementById('studyCardFront').innerHTML = tagHtml + frontContent;
                document.getElementById('studyCardBack').innerHTML = tagHtml + backContent;
                document.getElementById('cardCounter').textContent = 
                    `${this.studyIndex + 1} / ${this.studyCards.length}`;
                
                const flashcardFaces = document.querySelectorAll('.flashcard-face');
                if (deck) {
                    const gradientStart = deck.cardGradientStart || '#2a2a2a';
                    const gradientEnd = deck.cardGradientEnd || '#1f1f1f';
                    const deckColor = deck.color || '#888888';
                    
                    flashcardFaces.forEach(face => {
                        face.style.background = `linear-gradient(135deg, ${gradientStart}, ${gradientEnd})`;
                        face.style.borderColor = deckColor;
                    });
                }
                
                const flashcard = document.getElementById('flashcard');
                flashcard.classList.remove('flipped');
            },

            flipCard() {
                document.getElementById('flashcard').classList.toggle('flipped');
            },

            nextCard() {
                if (this.studyIndex < this.studyCards.length - 1) {
                    this.studyIndex++;
                    this.showStudyCard();
                }
            },

            prevCard() {
                if (this.studyIndex > 0) {
                    this.studyIndex--;
                    this.showStudyCard();
                }
            },

            exitStudy() {
                clearInterval(this.studyTimer);
                document.getElementById('studyArea').style.display = 'none';
                document.getElementById('studySetup').style.display = 'block';
            },

            // --- PRINT TOOLS ---
            showPrintInterface() {
                document.getElementById('studySetup').style.display = 'none';
                document.getElementById('printSetup').style.display = 'block';
                this.renderPrintDecks();
                this.printState.selectedDecks = [];
                this.printState.selectedCards = [];
                this.updatePrintCardList();
            },

            hidePrintInterface() {
                document.getElementById('printSetup').style.display = 'none';
                document.getElementById('studySetup').style.display = 'block';
            },

            renderPrintDecks() {
                const container = document.getElementById('printDeckSelection');
                container.innerHTML = this.decks.map(deck => {
                    const cardCount = this.cards.filter(c => c.deckId === deck.id).length;
                    return `
                        <label class="interactive-label">
                            <input type="checkbox" onchange="app.togglePrintDeck(${deck.id}, this.checked)">
                            <span>${deck.name} (${cardCount})</span>
                        </label>
                    `;
                }).join('');
            },

            togglePrintDeck(deckId, isChecked) {
                if (isChecked) {
                    this.printState.selectedDecks.push(deckId);
                } else {
                    this.printState.selectedDecks = this.printState.selectedDecks.filter(id => id !== deckId);
                }
                
                // When deck selection changes, we reset card selection for that deck
                const deckCards = this.cards.filter(c => c.deckId === deckId);
                if (isChecked) {
                    // Default to selecting all cards in the deck
                    deckCards.forEach(c => {
                        if(!this.printState.selectedCards.includes(c.id)) {
                            this.printState.selectedCards.push(c.id);
                        }
                    });
                } else {
                    // Remove cards from this deck
                    const deckCardIds = deckCards.map(c => c.id);
                    this.printState.selectedCards = this.printState.selectedCards.filter(id => !deckCardIds.includes(id));
                }

                this.updatePrintCardList();
            },

            toggleAllPrintCards(select) {
                if (this.printState.selectedDecks.length === 0) return;
                
                const allVisibleCards = this.cards.filter(c => this.printState.selectedDecks.includes(c.deckId));
                
                if (select) {
                    allVisibleCards.forEach(c => {
                        if(!this.printState.selectedCards.includes(c.id)) this.printState.selectedCards.push(c.id);
                    });
                } else {
                    this.printState.selectedCards = [];
                }
                this.updatePrintCardList();
            },

            togglePrintCard(cardId, isChecked) {
                if (isChecked) {
                    if(!this.printState.selectedCards.includes(cardId)) this.printState.selectedCards.push(cardId);
                } else {
                    this.printState.selectedCards = this.printState.selectedCards.filter(id => id !== cardId);
                }
            },

            updatePrintCardList() {
                const container = document.getElementById('printCardList');
                
                if (this.printState.selectedDecks.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Select decks to view cards</p>';
                    return;
                }

                const visibleCards = this.cards.filter(c => this.printState.selectedDecks.includes(c.deckId));
                
                // Group by Deck for nicer display
                let html = '';
                this.printState.selectedDecks.forEach(deckId => {
                    const deck = this.decks.find(d => d.id === deckId);
                    const cards = visibleCards.filter(c => c.deckId === deckId);
                    
                    if (cards.length > 0) {
                        html += `<h5 style="margin: 1rem 0 0.5rem; color: var(--accent);">${deck.name}</h5>`;
                        html += cards.map(c => `
                            <div class="print-card-item">
                                <input type="checkbox" ${this.printState.selectedCards.includes(c.id) ? 'checked' : ''} 
                                    onchange="app.togglePrintCard(${c.id}, this.checked)">
                                <div class="print-card-content">
                                    <div style="font-weight: 500;">${c.front}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.85rem;">${c.back}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                });
                
                container.innerHTML = html || '<p>No cards in selected decks</p>';
            },

            updatePrintMode(mode) {
                this.printState.mode = mode;
            },

            generatePrint() {
                const cardsToPrint = this.cards.filter(c => this.printState.selectedCards.includes(c.id));
                if (cardsToPrint.length === 0) {
                    alert('Please select at least one card.');
                    return;
                }

                const mode = this.printState.mode;
                const title = mode.includes('quiz') ? 'Quiz' : 'Study Sheet';
                const date = new Date().toLocaleDateString();

                // Open new window
                const printWindow = window.open('', '_blank');
                
                let contentHtml = '';
                
                if (mode === 'sheet') {
                    // Study Sheet Layout
                    contentHtml = `
                        <div class="grid">
                            ${cardsToPrint.map((c, i) => `
                                <div class="item">
                                    <div class="q"><span class="label">Q:</span> ${c.front}</div>
                                    <div class="a"><span class="label">A:</span> ${c.back}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    // Quiz Layout
                    contentHtml = `
                        <div class="questions">
                            ${cardsToPrint.map((c, i) => `
                                <div class="item">
                                    <div class="q">
                                        <span class="number">${i+1}.</span> 
                                        ${c.front}
                                    </div>
                                    <div class="space-line"></div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    // Add Answer Key if requested
                    if (mode === 'quiz_key') {
                        contentHtml += `
                            <div class="page-break"></div>
                            <h2>Answer Key</h2>
                            <div class="grid">
                                ${cardsToPrint.map((c, i) => `
                                    <div class="item small">
                                        <div class="a">
                                            <span class="number">${i+1}.</span> ${c.back}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }

                const html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${title} - re:call</title>
                        <style>
                            body { font-family: sans-serif; padding: 40px; color: #000; background: #fff; line-height: 1.5; }
                            h1 { margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                            .meta { color: #666; margin-bottom: 30px; }
                            
                            /* Grid for Study Sheet / Key */
                            .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                            .item { border: 1px solid #ccc; padding: 15px; border-radius: 4px; break-inside: avoid; page-break-inside: avoid; }
                            .item.small { padding: 10px; }
                            
                            .q { font-weight: bold; margin-bottom: 5px; }
                            .a { color: #333; }
                            .label { color: #999; font-size: 0.8em; margin-right: 5px; text-transform: uppercase; }
                            
                            /* Quiz Specific */
                            .number { display: inline-block; width: 25px; color: #666; }
                            .space-line { height: 40px; border-bottom: 1px solid #eee; margin-top: 10px; }
                            
                            .page-break { page-break-before: always; margin-top: 50px; }
                            
                            @media print {
                                body { padding: 0; }
                                .item { border-color: #000; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>${title}</h1>
                        <div class="meta">Generated on ${date} • ${cardsToPrint.length} items</div>
                        ${contentHtml}
                        <script>
                            window.onload = function() { window.print(); }
                        <\/script>
                    </body>
                    </html>
                `;

                printWindow.document.write(html);
                printWindow.document.close();
            },

            // Quiz Mode
            renderQuizSetup() {
                const container = document.getElementById('quizDeckSelection');
                container.innerHTML = this.decks.map(deck => {
                    const cardCount = this.cards.filter(c => c.deckId === deck.id).length;
                    return `
                        <label class="interactive-label">
                            <input type="checkbox" data-deck-id="${deck.id}">
                            <span>${deck.name} (${cardCount} cards)</span>
                        </label>
                    `;
                }).join('');
            },

            startQuiz() {
                const selected = Array.from(document.querySelectorAll('#quizDeckSelection input:checked'))
                    .map(cb => parseInt(cb.dataset.deckId));

                if (selected.length === 0) {
                    alert('Select at least one deck');
                    return;
                }

                const allCards = this.cards.filter(c => selected.includes(c.deckId));
                if (allCards.length === 0) {
                    alert('No cards in selected decks');
                    return;
                }

                const count = parseInt(document.getElementById('quizQuestionCount').value);
                const order = document.getElementById('quizOrder').value;
                const type = document.getElementById('quizType').value;

                let quizCards = [...allCards];
                if (order === 'random') {
                    quizCards = this.shuffle(quizCards);
                }
                quizCards = quizCards.slice(0, Math.min(count, quizCards.length));

                this.quizState = {
                    questions: quizCards.map(card => this.createQuestion(card, type, allCards)),
                    currentIndex: 0,
                    answers: [],
                    missedCards: []
                };

                document.getElementById('quizSetup').style.display = 'none';
                document.getElementById('quizArea').style.display = 'block';
                this.showQuestion();
            },

            createQuestion(card, type, allCards) {
                const types = type === 'mixed' ? 
                    ['typed', 'multiple', 'truefalse'] : [type];
                const selectedType = types[Math.floor(Math.random() * types.length)];

                const question = {
                    card: card,
                    type: selectedType,
                    question: card.front,
                    answer: card.back
                };

                if (selectedType === 'multiple') {
                    const others = allCards.filter(c => c.id !== card.id);
                    const distractors = this.shuffle(others).slice(0, 3).map(c => c.back);
                    question.options = this.shuffle([...distractors, card.back]);
                }

                if (selectedType === 'truefalse') {
                    const isTrue = Math.random() > 0.5;
                    if (!isTrue) {
                        const others = allCards.filter(c => c.id !== card.id);
                        if (others.length > 0) {
                            const wrongAnswer = others[Math.floor(Math.random() * others.length)].back;
                            question.answer = wrongAnswer;
                            question.correctAnswer = false;
                        } else {
                            question.correctAnswer = true;
                        }
                    } else {
                        question.correctAnswer = true;
                    }
                }

                return question;
            },

            showQuestion() {
                const q = this.quizState.questions[this.quizState.currentIndex];
                const progress = ((this.quizState.currentIndex + 1) / this.quizState.questions.length) * 100;
                document.getElementById('quizProgress').style.width = progress + '%';

                let html = `
                    <div class="card">
                        <h3 class="mb-1">Question ${this.quizState.currentIndex + 1} of ${this.quizState.questions.length}</h3>
                        <p style="font-size: 1.2rem; margin: 1.5rem 0;">${q.question}</p>
                `;

                if (q.type === 'typed') {
                    html += `
                        <input type="text" id="quizAnswer" placeholder="Type your answer..." 
                            onkeypress="if(event.key==='Enter') app.submitAnswer()">
                        <button class="btn btn-primary mt-2" onclick="app.submitAnswer()">Submit</button>
                    `;
                } else if (q.type === 'multiple') {
                    html += '<div class="quiz-options">';
                    q.options.forEach((opt, i) => {
                        html += `
                            <div class="quiz-option" onclick="app.selectOption(${i})">
                                ${i + 1}. ${opt}
                            </div>
                        `;
                    });
                    html += '</div>';
                } else if (q.type === 'truefalse') {
                    html += `
                        <p style="font-size: 1.1rem; margin: 1rem 0;">Answer: ${q.answer}</p>
                        <div class="quiz-options">
                            <div class="quiz-option" onclick="app.submitTrueFalse(true)">
                                True (T)
                            </div>
                            <div class="quiz-option" onclick="app.submitTrueFalse(false)">
                                False (F)
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                document.getElementById('quizQuestion').innerHTML = html;
            },

            selectOption(index) {
                const q = this.quizState.questions[this.quizState.currentIndex];
                const selected = q.options[index];
                const correct = selected === q.card.back;

                this.registerResult(q.card, correct);
                
                this.quizState.answers.push({ correct, userAnswer: selected });
                if (!correct) this.quizState.missedCards.push(q.card);

                const options = document.querySelectorAll('.quiz-option');
                options.forEach(opt => opt.style.pointerEvents = 'none');
                options[index].classList.add(correct ? 'correct' : 'incorrect');
                
                if (!correct) {
                    const correctIndex = q.options.indexOf(q.card.back);
                    options[correctIndex].classList.add('correct');
                }

                this.showNextButton();
            },

            submitAnswer() {
                const q = this.quizState.questions[this.quizState.currentIndex];
                const input = document.getElementById('quizAnswer');
                const answer = input.value.trim().toLowerCase();
                const correct = answer === q.card.back.toLowerCase();

                this.registerResult(q.card, correct);

                this.quizState.answers.push({ correct, userAnswer: answer });
                if (!correct) this.quizState.missedCards.push(q.card);

                input.disabled = true;
                const submitBtn = input.nextElementSibling;
                if (submitBtn) submitBtn.style.display = 'none';

                const feedback = correct ? 
                    '<p style="color: #4a7; margin-top: 1rem;">✓ Correct!</p>' :
                    `<p style="color: #a44; margin-top: 1rem;">✗ Incorrect. Answer: ${q.card.back}</p>`;
                
                document.getElementById('quizQuestion').innerHTML += feedback;
                this.showNextButton();
            },

            submitTrueFalse(answer) {
                const q = this.quizState.questions[this.quizState.currentIndex];
                const correct = answer === q.correctAnswer;

                this.registerResult(q.card, correct);

                this.quizState.answers.push({ correct, userAnswer: answer });
                if (!correct) this.quizState.missedCards.push(q.card);

                const options = document.querySelectorAll('.quiz-option');
                options.forEach(opt => opt.style.pointerEvents = 'none');
                const selectedIndex = answer ? 0 : 1;
                options[selectedIndex].classList.add(correct ? 'correct' : 'incorrect');
                
                if (!correct) {
                    options[answer ? 1 : 0].classList.add('correct');
                }

                this.showNextButton();
            },

            registerResult(card, correct) {
                // Update persistent stats
                const persistentCard = this.cards.find(c => c.id === card.id);
                if (persistentCard) {
                    persistentCard.stats.attempts++;
                    if (correct) persistentCard.stats.correct++;
                    persistentCard.stats.history.push({
                        timestamp: Date.now(),
                        result: correct ? 'correct' : 'incorrect'
                    });
                    this.saveData();
                }
            },

            showNextButton() {
                const container = document.getElementById('quizQuestion');
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-primary';
                nextBtn.textContent = 'Next Question';
                nextBtn.style.marginTop = '1.5rem';
                nextBtn.onclick = () => this.nextQuestion();
                container.appendChild(nextBtn);
            },

            nextQuestion() {
                this.quizState.currentIndex++;
                if (this.quizState.currentIndex >= this.quizState.questions.length) {
                    this.showResults();
                } else {
                    this.showQuestion();
                }
            },

            showResults() {
                const correct = this.quizState.answers.filter(a => a.correct).length;
                const total = this.quizState.answers.length;
                const percentage = Math.round((correct / total) * 100);

                document.getElementById('quizArea').style.display = 'none';
                document.getElementById('quizResults').style.display = 'block';
                document.getElementById('quizScore').textContent = percentage + '%';
                document.getElementById('correctCount').textContent = correct;
                document.getElementById('incorrectCount').textContent = total - correct;
            },

            retryMissed() {
                if (this.quizState.missedCards.length === 0) {
                    return;
                }

                const type = document.getElementById('quizType').value;
                this.quizState = {
                    questions: this.quizState.missedCards.map(card => 
                        this.createQuestion(card, type, this.cards)),
                    currentIndex: 0,
                    answers: [],
                    missedCards: []
                };

                document.getElementById('quizResults').style.display = 'none';
                document.getElementById('quizArea').style.display = 'block';
                this.showQuestion();
            },

            studyMissed() {
                if (this.quizState.missedCards.length === 0) {
                    return;
                }

                this.studyCards = this.quizState.missedCards;
                this.studyIndex = 0;
                this.navigateTo('study');
                
                setTimeout(() => {
                    document.getElementById('studySetup').style.display = 'none';
                    document.getElementById('studyArea').style.display = 'block';
                    this.showStudyCard();
                }, 100);
            },

            restartQuiz() {
                document.getElementById('quizResults').style.display = 'none';
                document.getElementById('quizSetup').style.display = 'block';
            },

            // Stats Mode
            renderStats() {
                // Calculate Stats
                let totalReviews = 0;
                let totalCorrect = 0;
                let dailyActivity = {};

                // Initialize last 7 days with 0
                for(let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    dailyActivity[d.toDateString()] = 0;
                }

                this.cards.forEach(c => {
                    totalReviews += c.stats.attempts;
                    totalCorrect += c.stats.correct;
                    c.stats.history.forEach(h => {
                        const d = new Date(h.timestamp).toDateString();
                        if (dailyActivity.hasOwnProperty(d)) {
                            dailyActivity[d]++;
                        }
                    });
                });

                const accuracy = totalReviews === 0 ? 0 : Math.round((totalCorrect / totalReviews) * 100);

                document.getElementById('statsTotalReviews').textContent = totalReviews;
                document.getElementById('statsGlobalAccuracy').textContent = accuracy + '%';

                // Render Chart
                this.renderChart(dailyActivity);

                // Render Difficult Cards
                const difficult = this.cards
                    .filter(c => c.stats.attempts > 0)
                    .map(c => ({
                        ...c,
                        acc: (c.stats.correct / c.stats.attempts) * 100
                    }))
                    .sort((a, b) => a.acc - b.acc)
                    .slice(0, 5);

                const diffContainer = document.getElementById('difficultCardsList');
                if (difficult.length === 0) {
                    diffContainer.innerHTML = '<p class="text-center" style="color:var(--text-secondary)">No review data yet. Take a quiz to generate stats!</p>';
                } else {
                    diffContainer.innerHTML = difficult.map(c => `
                        <div class="card">
                            <div class="flex justify-between">
                                <span>${c.front}</span>
                                <span style="color: ${c.acc < 50 ? '#a44' : '#d94'}; font-weight:bold;">${Math.round(c.acc)}% Accuracy</span>
                            </div>
                            <p style="color:var(--text-secondary); font-size:0.85rem; margin-top:0.5rem;">${c.stats.correct} / ${c.stats.attempts} correct</p>
                        </div>
                    `).join('');
                }
            },

            renderChart(data) {
                const canvas = document.getElementById('activityChart');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                
                const labels = Object.keys(data).map(d => {
                    const date = new Date(d);
                    return `${date.getMonth()+1}/${date.getDate()}`;
                });
                const values = Object.values(data);
                
                // Clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (Math.max(...values) === 0) {
                    ctx.fillStyle = '#666';
                    ctx.textAlign = 'center';
                    ctx.fillText('No activity in last 7 days', canvas.width/2, canvas.height/2);
                    return;
                }

                // Drawing logic
                const padding = 40;
                const chartWidth = canvas.width - (padding * 2);
                const chartHeight = canvas.height - (padding * 2);
                const maxVal = Math.max(...values, 5); // Minimum y-scale of 5

                // Draw Axes
                ctx.strokeStyle = '#444';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, canvas.height - padding);
                ctx.lineTo(canvas.width - padding, canvas.height - padding);
                ctx.stroke();

                // Draw Line
                ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent');
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const stepX = chartWidth / (values.length - 1);
                
                values.forEach((val, i) => {
                    const x = padding + (i * stepX);
                    const y = canvas.height - padding - ((val / maxVal) * chartHeight);
                    
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    
                    // Draw point
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(x - 2, y - 2, 4, 4);
                    
                    // Label
                    ctx.fillStyle = '#888';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(labels[i], x, canvas.height - padding + 15);
                });
                ctx.stroke();
            },

            // Theme
            loadTheme() {
                const accent = localStorage.getItem('recall_accent');
                const bgStart = localStorage.getItem('recall_bg_start');
                const bgEnd = localStorage.getItem('recall_bg_end');
                const cardStart = localStorage.getItem('recall_card_start');
                const cardEnd = localStorage.getItem('recall_card_end');
                
                if (accent) {
                    document.getElementById('accentColor').value = accent;
                }
                if (bgStart && bgEnd) {
                    document.getElementById('bgGradientStart').value = bgStart;
                    document.getElementById('bgGradientEnd').value = bgEnd;
                }
                if (cardStart && cardEnd) {
                    document.getElementById('cardGradientStart').value = cardStart;
                    document.getElementById('cardGradientEnd').value = cardEnd;
                }
                
                if (accent || bgStart || cardStart) {
                    this.applyThemeColors(accent, bgStart, bgEnd, cardStart, cardEnd);
                }
                
                this.updateGradientPreview();
            },

            // Data Export/Import
            exportData() {
                const data = {
                    decks: this.decks,
                    cards: this.cards,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const exportText = JSON.stringify(data, null, 2);
                document.getElementById('exportData').value = exportText;
                
                this.showMessage('exportMessage', 'Data exported! Copy the text above to save it.', 'success');
            },

            copyExport() {
                const textarea = document.getElementById('exportData');
                if (!textarea.value) {
                    this.showMessage('exportMessage', 'Generate export data first', 'error');
                    return;
                }
                
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textarea.value)
                        .then(() => {
                            this.showMessage('exportMessage', 'Copied to clipboard!', 'success');
                        })
                        .catch(() => {
                            // Fallback to older method
                            textarea.select();
                            document.execCommand('copy');
                            this.showMessage('exportMessage', 'Copied to clipboard!', 'success');
                        });
                } else {
                    // Fallback for older browsers
                    textarea.select();
                    document.execCommand('copy');
                    this.showMessage('exportMessage', 'Copied to clipboard!', 'success');
                }
            },

            importData() {
                const importText = document.getElementById('importData').value.trim();
                if (!importText) {
                    this.showMessage('importMessage', 'Please paste your export data first', 'error');
                    return;
                }
                
                try {
                    const data = JSON.parse(importText);
                    
                    // Validate data structure
                    if (!data.decks || !data.cards || !Array.isArray(data.decks) || !Array.isArray(data.cards)) {
                        throw new Error('Invalid data format - missing decks or cards array');
                    }
                    
                    // Store pending data
                    this.pendingImportData = data;
                    
                    // Show confirmation modal with preview
                    document.getElementById('importDeckCount').textContent = data.decks.length;
                    document.getElementById('importCardCount').textContent = data.cards.length;
                    document.getElementById('importConfirmModal').classList.add('active');
                    
                } catch (error) {
                    this.showMessage('importMessage', 
                        'Error parsing data: ' + error.message + '. Please check your export data.', 
                        'error');
                }
            },

            closeImportModal() {
                document.getElementById('importConfirmModal').classList.remove('active');
                this.pendingImportData = null;
            },

            confirmImport() {
                if (!this.pendingImportData) return;
                
                try {
                    // Load data
                    this.decks = this.pendingImportData.decks;
                    this.cards = this.pendingImportData.cards;
                    this.saveData();
                    
                    // Refresh all views
                    this.renderDecks();
                    this.populateDeckSelects();
                    
                    // Clear import field
                    document.getElementById('importData').value = '';
                    
                    // Close modal
                    this.closeImportModal();
                    
                    // Show success message
                    this.showMessage('importMessage', 
                        `Data imported successfully! ${this.decks.length} decks and ${this.cards.length} cards loaded.`, 
                        'success');
                    
                } catch (error) {
                    this.closeImportModal();
                    this.showMessage('importMessage', 
                        'Error importing data: ' + error.message, 
                        'error');
                }
            },

            showMessage(id, text, type) {
                // Remove existing message if any
                const existing = document.getElementById(id);
                if (existing) existing.remove();
                
                // Create new message
                const message = document.createElement('div');
                message.id = id;
                message.className = `message ${type}`;
                message.textContent = text;
                
                // Insert after the appropriate element
                if (id === 'exportMessage') {
                    const exportSection = document.querySelector('#exportData').parentElement;
                    exportSection.appendChild(message);
                } else if (id === 'importMessage') {
                    const importSection = document.querySelector('#importData').parentElement;
                    importSection.appendChild(message);
                }
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (message.parentElement) {
                        message.style.opacity = '0';
                        message.style.transition = 'opacity 0.28s ease';
                        setTimeout(() => message.remove(), 280);
                    }
                }, 5000);
            },

            applyTheme() {
                const accent = document.getElementById('accentColor').value;
                const bgStart = document.getElementById('bgGradientStart').value;
                const bgEnd = document.getElementById('bgGradientEnd').value;
                const cardStart = document.getElementById('cardGradientStart').value;
                const cardEnd = document.getElementById('cardGradientEnd').value;
                
                this.applyThemeColors(accent, bgStart, bgEnd, cardStart, cardEnd);
                
                localStorage.setItem('recall_accent', accent);
                localStorage.setItem('recall_bg_start', bgStart);
                localStorage.setItem('recall_bg_end', bgEnd);
                localStorage.setItem('recall_card_start', cardStart);
                localStorage.setItem('recall_card_end', cardEnd);
            },

            applyThemeColors(accent, bgStart, bgEnd, cardStart, cardEnd) {
                if (accent) {
                    document.documentElement.style.setProperty('--accent', accent);
                }
                if (bgStart && bgEnd) {
                    document.documentElement.style.setProperty('--bg-primary', bgStart);
                    document.body.style.background = `linear-gradient(180deg, ${bgStart}, ${bgEnd})`;
                    document.body.style.minHeight = '100vh';
                }
                if (cardStart && cardEnd) {
                    document.documentElement.style.setProperty('--gradient-start', cardStart);
                    document.documentElement.style.setProperty('--gradient-end', cardEnd);
                }
            },

            updateGradientPreview() {
                const bgStart = document.getElementById('bgGradientStart').value;
                const bgEnd = document.getElementById('bgGradientEnd').value;
                const preview = document.getElementById('gradientPreview');
                if (preview) {
                    preview.style.background = `linear-gradient(180deg, ${bgStart}, ${bgEnd})`;
                }
            },

            resetTheme() {
                document.documentElement.style.setProperty('--accent', '#888');
                document.documentElement.style.setProperty('--bg-primary', '#1a1a1a');
                document.documentElement.style.setProperty('--gradient-start', '#2a2a2a');
                document.documentElement.style.setProperty('--gradient-end', '#1f1f1f');
                document.body.style.background = '#1a1a1a';
                
                document.getElementById('accentColor').value = '#888888';
                document.getElementById('bgGradientStart').value = '#1a1a1a';
                document.getElementById('bgGradientEnd').value = '#0f0f0f';
                document.getElementById('cardGradientStart').value = '#2a2a2a';
                document.getElementById('cardGradientEnd').value = '#1f1f1f';
                
                localStorage.removeItem('recall_accent');
                localStorage.removeItem('recall_bg_start');
                localStorage.removeItem('recall_bg_end');
                localStorage.removeItem('recall_card_start');
                localStorage.removeItem('recall_card_end');
                
                this.updateGradientPreview();
            },

            // Keyboard Shortcuts
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Study mode shortcuts
                    if (document.getElementById('studyArea').style.display !== 'none') {
                        if (e.code === 'Space') {
                            e.preventDefault();
                            this.flipCard();
                        }
                        if (e.code === 'ArrowLeft') this.prevCard();
                        if (e.code === 'ArrowRight') this.nextCard();
                        if (e.code === 'KeyK') this.markAsKnown(); // Add shortcut for marking as known
                    }

                    // Quiz shortcuts
                    if (document.getElementById('quizArea').style.display !== 'none') {
                        const q = this.quizState.questions[this.quizState.currentIndex];
                        
                        // Check if there's a next button (answer already submitted)
                        const nextBtn = document.querySelector('#quizQuestion .btn-primary');
                        if (nextBtn && e.code === 'Enter') {
                            nextBtn.click();
                            return;
                        }
                        
                        if (q && q.type === 'multiple') {
                            if (e.key >= '1' && e.key <= '4') {
                                const options = document.querySelectorAll('.quiz-option');
                                if (options[parseInt(e.key) - 1] && options[0].style.pointerEvents !== 'none') {
                                    this.selectOption(parseInt(e.key) - 1);
                                }
                            }
                        }
                        if (q && q.type === 'truefalse') {
                            const options = document.querySelectorAll('.quiz-option');
                            if (options.length > 0 && options[0].style.pointerEvents !== 'none') {
                                if (e.key.toLowerCase() === 't') this.submitTrueFalse(true);
                                if (e.key.toLowerCase() === 'f') this.submitTrueFalse(false);
                            }
                        }
                    }
                });
            },

            // Utilities
            shuffle(array) {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }
        };

        // Initialize app
        app.init();
    </script>
</body>
</html>
